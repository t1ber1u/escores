import { Config } from '@wdio/sync';
import path from 'path';
import fs from 'fs';

function resolveDynamicPath(basePath: string, pattern: string): string {
    const directories = fs.readdirSync(basePath, { withFileTypes: true })
        .filter(dirent => dirent.isDirectory() && dirent.name.includes(pattern))
        .map(dirent => path.join(basePath, dirent.name));

    if (directories.length !== 1) {
        throw new Error(`Expected exactly one directory matching pattern ${pattern} in ${basePath}, found ${directories.length}`);
    }

    return directories[0];
}

const chromeBasePath = path.resolve(__dirname, './chrome');
const chromeDriverPath = path.resolve(__dirname, './chromedriver');

const chromePath = resolveDynamicPath(chromeBasePath, 'mac_arm');

const isWindows = process.platform === 'win32';
const chromeBinary = isWindows ? 'chrome.exe' : path.join('Google Chrome for Testing.app', 'Contents', 'MacOS', 'Google Chrome for Testing');
const chromeDriverBinary = isWindows ? 'chromedriver.exe' : 'chromedriver';

console.log('Resolved Chrome path:', path.join(chromePath, chromeBinary));
console.log('Resolved ChromeDriver path:', path.join(chromeDriverPath, chromeDriverBinary));

export const config: Config = {
    runner: 'local',
    specs: [
        './test/specs/**/*.ts'
    ],
    maxInstances: 1,
    capabilities: [{
        maxInstances: 1,
        browserName: 'chrome',
        'goog:chromeOptions': {
            binary: path.join(chromePath, chromeBinary),
        },
    }],
    logLevel: 'info',
    bail: 0,
    baseUrl: 'http://localhost',
    waitforTimeout: 10000,
    connectionRetryTimeout: 120000,
    connectionRetryCount: 3,
    services: [
        ['chromedriver', {
            chromedriverCustomPath: path.join(chromeDriverPath, chromeDriverBinary),
        }]
    ],
    framework: 'mocha',
    reporters: ['spec'],
    mochaOpts: {
        ui: 'bdd',
        timeout: 60000
    }
};