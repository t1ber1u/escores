import { Before, After, AfterAll } from '@wdio/cucumber-framework';
import cucumberJson from 'wdio-cucumberjs-json-reporter';
import { browser } from '@wdio/globals';
import BrowserWrapper from '../support/browserWrapper';

let browserWrapper: BrowserWrapper;
let executedUIScenarios = false;

Before(async (scenario) => {
  browserWrapper = new BrowserWrapper(browser);

  // Check if the scenario has the @ui tag
  const tags = scenario.pickle.tags.map(tag => tag.name);
  if (tags.includes('@ui')) {
    executedUIScenarios = true;
    await browserWrapper.loadSessionCookies();
    await browserWrapper.goToURL('https://example.com');
  }
});

After(async function (scenario) {
  // Check if the scenario has the @ui tag
  const tags = scenario.pickle.tags.map(tag => tag.name);
  if (tags.includes('@ui')) {
    if (scenario.result.status === 'FAILED') {
      console.log('Expected test to pass but failed!');
      // Take screenshot
      const screenshot = await browser.takeScreenshot();
      // Attach a screenshot in a before hook
      cucumberJson.attach(screenshot, 'image/png');
    }
    await browserWrapper.saveSessionCookies();
  }
});

// Separate hook to delete the cookies file after all tests have executed
AfterAll(async () => {
  if (executedUIScenarios) {
    await browserWrapper.deleteSessionCookiesFile();
  }
});