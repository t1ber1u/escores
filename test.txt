import { Given, When, Then } from '@cucumber/cucumber';
import { browser } from 'webdriverio';
import { TOTP } from 'totp-generator';
import moment from 'moment-timezone';

const secret = 'JBSWY3DPEHPK3PXP'; // Replace with your actual TOTP secret

const getCurrentTimeInBucharest = (): number => {
  const currentTime = moment();
  const currentTimezone = currentTime.tz();
  
  if (currentTimezone !== 'Europe/Bucharest') {
    const bucharestTime = currentTime.tz('Europe/Bucharest');
    return bucharestTime.valueOf(); // Current time in milliseconds in Bucharest timezone
  }

  return currentTime.valueOf(); // Current time in milliseconds in the local timezone
};

Given('I am on the main page', async () => {
  await browser.url('https://your-main-page-url.com');
});

When(/^I input the email (.*) and press (.*)$/, async (email: string, button: string) => {
  await $('//input[@placeholder="Email address"]').setValue(email);
  await $(`//button[contains(., '${button}')]`).click();
});

When(/^I input the password (.*) and press (.*)$/, async (password: string, button: string) => {
  await $('//input[@placeholder="Password"]').setValue(password);
  await $(`//button[contains(., '${button}')]`).click();
});

When(/^I input the TAN from the device and press (.*)$/, async (button: string) => {
  const currentTimeInBucharest = getCurrentTimeInBucharest();
  const otp = TOTP.generate(secret, { algorithm: 'SHA-1', timestamp: currentTimeInBucharest });
  console.log(`Generated TAN: ${otp} at time: ${currentTimeInBucharest}`);
  await $('//input[@data-testid="code_input"]').setValue(otp);
  await $(`//button[contains(., '${button}')]`).click();
});

Then('I should be successfully authenticated and see the main page', async () => {
  const isMainPageVisible = await $('#main-page-identifier').isDisplayed(); // Replace with your actual main page identifier
  expect(isMainPageVisible).toBe(true);
});